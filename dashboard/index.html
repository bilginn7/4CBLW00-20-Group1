<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>London Burglary Predictor Dashboard</title>

    <!-- Google Fonts - DM Sans -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet">

    <!-- External CSS Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <h1>London Burglary Predictor Dashboard</h1>

        <div class="controls">
            <div class="control-group">
                <label for="borough-select">Borough:</label>
                <select id="borough-select">
                    <option value="">Select Borough</option>
                </select>
            </div>
            <div class="control-group">
                <label for="ward-select">Ward:</label>
                <select id="ward-select" disabled>
                    <option value="">Select Ward</option>
                </select>
            </div>
            <div class="control-group">
                <label for="lsoa-select">LSOA:</label>
                <select id="lsoa-select" disabled>
                    <option value="">Select LSOA</option>
                </select>
            </div>
            <div class="control-group">
                <label>&nbsp;</label>
                <button id="reset-button" class="reset-btn">
                    üîÑ Reset
                </button>
            </div>
        </div>

        <div class="main-content">
            <div class="map-section">
                <div class="map-container">
                    <div id="map"></div>
                </div>
            </div>

            <div class="charts-section">
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="controls">
                            <span class="title">Burglary count per month</span>
                            <div class="date-filters">
                                <label for="start-date">From:</label>
                                <input type="month" id="start-date" class="date-input">
                                <label for="end-date">To:</label>
                                <input type="month" id="end-date" class="date-input">
                                <button id="apply-filter" class="filter-btn">Filter</button>
                                <button id="reset-filter" class="filter-btn">Reset</button>
                            </div>
                        </div>
                    </div>
                    <div class="chart-content">
                        <canvas id="burglary-chart" class="chart-canvas"></canvas>
                        <div id="burglary-empty" class="empty-state" style="display: none;">
                            Select Borough, Ward, and LSOA to view data
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <div class="controls">
                            <span class="title">officers per hour</span>
                            <select id="month-select" disabled>
                                <option value="">Select Month</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-content">
                        <canvas id="officers-chart" class="chart-canvas"></canvas>
                        <div id="officers-empty" class="empty-state" style="display: none;">
                            Select Borough, Ward, LSOA, and Month to view data
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- External JavaScript Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js"></script>

    <!-- Try Apache Arrow parquet library instead -->
    <script type="module">
        console.log('üîÑ Loading Arrow Parquet libraries...');

        try {
            // Try Apache Arrow library which has better compression support
            const arrow = await import('https://cdn.jsdelivr.net/npm/apache-arrow@latest/+esm');
            const { tableFromIPC } = arrow;

            window.parquet = {
                async readParquet(data) {
                    // Try different Arrow methods
                    try {
                        const table = arrow.tableFromArrayBuffer(data);
                        return {
                            toObject() {
                                return table.toArray().map(row => row.toJSON());
                            }
                        };
                    } catch (e1) {
                        console.warn('Arrow tableFromArrayBuffer failed:', e1.message);
                        throw new Error('Arrow parquet reading failed');
                    }
                }
            };
            console.log('‚úÖ Apache Arrow loaded');
        } catch (arrowError) {
            console.warn('‚ö†Ô∏è Apache Arrow failed:', arrowError.message);

            // Fallback to parquet-wasm
            try {
                const { readParquet } = await import('https://cdn.jsdelivr.net/npm/parquet-wasm@latest/+esm');
                window.parquet = { readParquet };
                console.log('‚úÖ parquet-wasm fallback loaded');
            } catch (wasmError) {
                console.error('‚ùå All parquet libraries failed');
                throw wasmError;
            }
        }

        // Load GeoParquet
        const { toGeoJson } = await import('https://cdn.jsdelivr.net/npm/geoparquet@0.3.0/+esm');
        window.geoparquet = {
            decode(buffer) {
                const arrayBuf = buffer instanceof ArrayBuffer ? buffer : buffer.buffer;
                return toGeoJson({ file: arrayBuf });
            }
        };
        console.log('‚úÖ geoparquet loaded');
    </script>

    <!-- Register Chart.js Annotation Plugin -->
    <script>
        if (typeof Chart !== 'undefined' && typeof window.ChartAnnotation !== 'undefined') {
            Chart.register(window.ChartAnnotation);
            console.log('‚úÖ Chart.js annotation plugin registered');
        }
    </script>

    <!-- Custom JavaScript Modules -->
    <script src="js/config.js"></script>
    <script src="js/dataService.js"></script>
    <script src="js/mapController.js"></script>
    <script src="js/chartController.js"></script>
    <script src="js/uiController.js"></script>
    <script src="js/app.js"></script>
</body>
</html>